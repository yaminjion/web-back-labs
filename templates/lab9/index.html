<!-- templates/lab9/index.html -->

{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block lab_title %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const boxes = document.querySelectorAll('.gift-box');
    const remainingSpan = document.getElementById('remaining');

    boxes.forEach(box => {
        box.addEventListener('click', function() {
            const index = parseInt(this.dataset.index);
            fetch('/lab9/open_box', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞
                    const giftDiv = document.createElement('div');
                    giftDiv.className = 'gift-popup';
                    giftDiv.innerHTML = `
                        <img src="/static/gifts/${data.gift_image}" alt="–ü–æ–¥–∞—Ä–æ–∫" class="gift-image">
                        <p>${data.congratulation}</p>
                    `;
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ–¥–∞—Ä–æ–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                    const oldGift = this.querySelector('.gift-popup');
                    if (oldGift) oldGift.remove();
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                    this.appendChild(giftDiv);

                    // –ú–µ–Ω—è–µ–º —Å—Ç–∏–ª—å –∫–æ—Ä–æ–±–∫–∏
                    this.style.opacity = '0.4';
                    this.style.pointerEvents = 'none';

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
                    remainingSpan.textContent = data.remaining;
                } else if (data.status === 'already_opened') {
                    alert('–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!');
                } else if (data.status === 'limit_reached') {
                    alert('–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏. –ë–æ–ª—å—à–µ –Ω–µ–ª—å–∑—è!');
                } else if (data.status === 'auth_required') {
                    alert('–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!');
                }
            });
        });
    });

    // –ö–Ω–æ–ø–∫–∞ "–î–µ–¥ –ú–æ—Ä–æ–∑"
    const dedMorozBtn = document.getElementById('ded-moroz');
    if (dedMorozBtn) {
        dedMorozBtn.addEventListener('click', function() {
            fetch('/lab9/reset_boxes', { method: 'POST' })
                .then(() => location.reload());
        });
    }
});
</script>

<style>
/* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª–∏ body –¥–ª—è –Ω–æ–≤–æ–≥–æ–¥–Ω–µ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è */
body {
    background: linear-gradient(135deg, #0a3d1d, #1a5c2d) !important;
    color: white !important;
    font-family: "Times New Roman", serif !important;
    min-height: 100vh !important;
    overflow-x: hidden !important;
    position: relative !important;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
h1 {
    font-size: 2.5em;
    margin: 20px 0 10px;
    color: #ffcc00;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

/* –°—Ç–∏–ª—å –¥–ª—è —Ç–µ–∫—Å—Ç–∞ "–û—Å—Ç–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å" */
#stats {
    font-size: 1.2em;
    color: #ffcc00;
    font-weight: bold;
    margin-bottom: 20px;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–æ—Ä–æ–±–æ–∫ */
.gift-box {
    position: absolute;
    cursor: pointer;
    transition: transform 0.3s, opacity 0.3s;
    z-index: 10;
    width: 100px;
    height: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #ffcc00;
    border-radius: 8px;
    background: white;
    box-shadow: 0 4px 12px rgba(255,204,0,0.5);
    /* –î–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ ‚Äî –¥–æ–±–∞–≤–∏–º padding */
    padding: 5px;
    box-sizing: border-box;
}

.gift-box:hover {
    transform: scale(1.05) rotate(3deg);
    z-index: 100;
}

.gift-box img {
    width: 80px;
    height: auto;
    border-radius: 5px;
}

/* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ä–æ–±–∫–∏ */
.gift-popup {
    position: absolute;
    top: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 15px;
    border-radius: 8px;
    max-width: 200px;
    text-align: center;
    z-index: 200;
    animation: fadeIn 0.3s ease-in;
}

.gift-popup img {
    width: 100px;
    height: auto;
    border: 2px solid #ffcc00;
    border-radius: 5px;
    margin-bottom: 10px;
}

.gift-popup p {
    font-size: 0.9em;
    color: #fff;
    margin: 0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateX(-50%) translateY(-10px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –î–µ–¥ –ú–æ—Ä–æ–∑ */
#ded-moroz {
    margin-top: 15px;
    padding: 8px 15px;
    background: #e53935;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
}

#ded-moroz:hover {
    background: #d32f2f;
}
</style>
{% endblock %}

{% block main %}
    <div style="text-align: center; padding: 20px;">
        <h1>üéÑ –° –ù–æ–≤—ã–º –ì–æ–¥–æ–º! üéÑ</h1>
        <div id="stats">
            –û—Å—Ç–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å: <span id="remaining">{{ remaining }}</span> –∫–æ—Ä–æ–±–æ–∫
        </div>

        {% for item in box_data %}
            <div class="gift-box"
                 style="left: {{ item.x }}px; top: {{ item.y }}px;"
                 data-index="{{ item.index }}"
                 {% if item.is_opened %}style="opacity: 0.4; pointer-events: none;"{% endif %}>
                <img src="/static/boxes/{{ item.name }}" alt="–ö–æ—Ä–æ–±–∫–∞">
            </div>
        {% endfor %}

        {% if is_authenticated %}
            <button id="ded-moroz">–î–µ–¥ –ú–æ—Ä–æ–∑ ‚Äî –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä–æ–±–∫–∏!</button>
        {% endif %}
    </div>
{% endblock %}