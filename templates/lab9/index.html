{% extends "lab9_base.html" %}
{% block title %}–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏{% endblock %}
{% block lab_title %}–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏{% endblock %}

{% block main %}
<h1 style="text-align: center; color: #ffcc00;">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÑ</h1>

<div style="display: flex; justify-content: center; gap: 40px; margin: 20px 0; color: #ffcc00;">
    <div>–û—Ç–∫—Ä—ã—Ç–æ: <strong id="opened-count">{{ opened_count }}</strong>/3</div>
    <div>–û—Å—Ç–∞–ª–æ—Å—å: <strong id="remaining-count">{{ remaining_count }}</strong></div>
</div>

<div class="gifts-area" id="gifts-area" style="position: relative; height: 600px; background: rgba(255,255,255,0.05); border: 2px dashed #ffcc00; border-radius: 12px; margin: 20px 0;">
    {% for box in boxes_data %}
    <div class="gift-box {% if box.is_opened %}opened{% endif %}"
         data-id="{{ box.id }}"
         style="position: absolute; left: {{ box.x }}px; top: {{ box.y }}px; width: 100px; height: 100px; cursor: pointer; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
        {% if not box.is_opened %}
            <img src="/static/boxes/{{ box.image }}" style="width:100%; height:100%; object-fit:cover;">
        {% else %}
            <img src="/static/gifts/{{ gifts[box.id] }}" style="width:100%; height:100%; object-fit:cover;">
        {% endif %}
    </div>
    {% endfor %}
</div>

<div id="message" style="text-align: center; margin: 20px 0; min-height: 24px; color: #ffcc00; font-weight: bold;"></div>

{% if is_authenticated %}
    <button id="ded-moroz" style="display: block; margin: 20px auto; padding: 10px 20px; background: #d32f2f; color: white; border: none; border-radius: 6px; font-weight: bold;">–î–µ–¥ –ú–æ—Ä–æ–∑ ‚Äî –Ω–∞–ø–æ–ª–Ω–∏—Ç—å –∫–æ—Ä–æ–±–∫–∏!</button>
    <p style="text-align: center;">–ü—Ä–∏–≤–µ—Ç, <strong>{{ current_user.login }}</strong>! <a href="/lab9/logout">–í—ã–π—Ç–∏</a></p>
{% else %}
    <p style="text-align: center;">
        <a href="/lab9/login">–í–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="/lab9/register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏!
    </p>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
    const area = document.getElementById('gifts-area');
    const msg = document.getElementById('message');
    const opened = document.getElementById('opened-count');
    const remaining = document.getElementById('remaining-count');
    const ded = document.getElementById('ded-moroz');

    area.addEventListener('click', e => {
        const box = e.target.closest('.gift-box');
        if (!box || box.classList.contains('opened')) return;
        const id = box.dataset.id;

        fetch('/lab9/open_box', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({box_id: id})
        }).then(r => r.json()).then(data => {
            if (data.success) {
                box.classList.add('opened');
                box.innerHTML = `<img src="/static/gifts/${data.gift_image}" style="width:100%; height:100%; object-fit:cover;">`;
                msg.textContent = data.congratulation;
                msg.style.color = '#4caf50';
                opened.textContent = data.opened_count;
                remaining.textContent = 15 - data.opened_count;
            } else {
                msg.textContent = data.message;
                msg.style.color = '#f44336';
            }
            setTimeout(() => msg.textContent = '', 4000);
        });
    });

    if (ded) {
        ded.onclick = () => {
            fetch('/lab9/reset_boxes', {method: 'POST'}).then(() => location.reload());
        };
    }
});
</script>
{% endblock %}