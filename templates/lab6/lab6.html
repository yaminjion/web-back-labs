{% extends "base.html" %}

{% block lab %}Лабораторная работа №6{% endblock %}
{% block lab_title %}Лабораторная работа №6{% endblock %}

{% block content %}
<h1>Список кабинетов</h1>
<ul id="office-list"></ul>
<p id="total-cost">Общая стоимость вашей аренды: 0 ₽</p>
{% endblock %}

{% block script %}
<script>
    function fetchOffices() {
        const url = '/lab6/json-rpc-api/';
        const id = Math.floor(Math.random() * 1000);
        const payload = {
            jsonrpc: "2.0",
            method: "info",
            id: id
        };

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('office-list');
            const totalEl = document.getElementById('total-cost');
            list.innerHTML = '';
            let total = 0;
            const login = '{{ session.get("login") or "" }}';

            data.result.forEach(office => {
                const li = document.createElement('li');
                let text = `Кабинет №${office.number} — Стоимость: ${office.price} ₽`;
                if (office.tenant) {
                    text += ` — Арендатор: ${office.tenant}`;
                    if (office.tenant === login) {
                        total += office.price;
                    }
                } else {
                    text += ' — Свободен';
                }
                li.textContent = text;

                if (login) {
                    if (office.tenant === login) {
                        const btn = document.createElement('button');
                        btn.textContent = 'Освободить';
                        btn.onclick = () => cancellation(office.number);
                        li.appendChild(document.createTextNode(' '));
                        li.appendChild(btn);
                    } else if (!office.tenant) {
                        const btn = document.createElement('button');
                        btn.textContent = 'Забронировать';
                        btn.onclick = () => booking(office.number);
                        li.appendChild(document.createTextNode(' '));
                        li.appendChild(btn);
                    }
                }

                list.appendChild(li);
            });

            if (totalEl) {
                totalEl.textContent = `Общая стоимость вашей аренды: ${total} ₽`;
            }
        })
        .catch(err => {
            console.error('Ошибка загрузки списка кабинетов:', err);
        });
    }

    function booking(officeNumber) {
        const url = '/lab6/json-rpc-api/';
        const id = Math.floor(Math.random() * 1000);
        const payload = {
            jsonrpc: "2.0",
            method: "booking",
            params: officeNumber,
            id: id
        };

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                switch (data.error.code) {
                    case 1:
                        alert('Ошибка: Пользователь не авторизован');
                        break;
                    case 2:
                        alert('Ошибка: Офис уже занят');
                        break;
                    default:
                        alert('Ошибка: ' + data.error.message);
                }
            } else {
                fetchOffices();
            }
        })
        .catch(err => {
            console.error('Ошибка при бронировании:', err);
        });
    }

    function cancellation(officeNumber) {
        const url = '/lab6/json-rpc-api/';
        const id = Math.floor(Math.random() * 1000);
        const payload = {
            jsonrpc: "2.0",
            method: "cancellation",
            params: officeNumber,
            id: id
        };

        fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                switch (data.error.code) {
                    case 1:
                        alert('Ошибка: Пользователь не авторизован');
                        break;
                    case 3:
                        alert('Ошибка: Офис не арендован');
                        break;
                    case 4:
                        alert('Ошибка: Офис арендован другим пользователем');
                        break;
                    default:
                        alert('Ошибка: ' + data.error.message);
                }
            } else {
                fetchOffices();
            }
        })
        .catch(err => {
            console.error('Ошибка при освобождении:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', fetchOffices);
</script>
{% endblock %}